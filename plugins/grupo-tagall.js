/* 
- tagall By Angel-OFC  
- etiqueta en un grupo a todos con banderas 🇺🇸
- https://whatsapp.com/channel/0029VaJxgcB0bIdvuOwKTM2Y
*/
const handler = async (m, { isOwner, isAdmin, conn, text, participants, args, command, usedPrefix }) => {
  if (usedPrefix == 'a' || usedPrefix == 'A') return;

  const customEmoji = global.db.data.chats[m.chat]?.customEmoji || '🍫';
  m.react(customEmoji);

  if (!(isAdmin || isOwner)) {
    global.dfail('admin', m, conn);
    throw false;
  }

  // Función para obtener la bandera según el prefijo telefónico
  function getFlagFromNumber(number) {
    const countryFlags = {
      '1': '🇺🇸', '7': '🇷🇺', '20': '🇪🇬', '27': '🇿🇦',
      '30': '🇬🇷', '31': '🇳🇱', '32': '🇧🇪', '33': '🇫🇷', '34': '🇪🇸',
      '36': '🇭🇺', '39': '🇮🇹', '40': '🇷🇴', '41': '🇨🇭', '43': '🇦🇹',
      '44': '🇬🇧', '45': '🇩🇰', '46': '🇸🇪', '47': '🇳🇴', '48': '🇵🇱',
      '49': '🇩🇪', '51': '🇵🇪', '52': '🇲🇽', '53': '🇨🇺', '54': '🇦🇷',
      '55': '🇧🇷', '56': '🇨🇱', '57': '🇨🇴', '58': '🇻🇪', '60': '🇲🇾',
      '61': '🇦🇺', '62': '🇮🇩', '63': '🇵🇭', '64': '🇳🇿', '65': '🇸🇬',
      '66': '🇹🇭', '81': '🇯🇵', '82': '🇰🇷', '84': '🇻🇳', '86': '🇨🇳',
      '90': '🇹🇷', '91': '🇮🇳', '92': '🇵🇰', '93': '🇦🇫', '94': '🇱🇰',
      '95': '🇲🇲', '98': '🇮🇷', '211': '🇸🇸', '212': '🇲🇦', '213': '🇩🇿',
      '216': '🇹🇳', '218': '🇱🇾', '220': '🇬🇲', '221': '🇸🇳', '222': '🇲🇷',
      '223': '🇲🇱', '224': '🇬🇳', '225': '🇨🇮', '226': '🇧🇫', '227': '🇳🇪',
      '228': '🇹🇬', '229': '🇧🇯', '230': '🇲🇺', '231': '🇱🇷', '232': '🇸🇱',
      '233': '🇬🇭', '234': '🇳🇬', '235': '🇹🇩', '236': '🇨🇫', '237': '🇨🇲',
      '238': '🇨🇻', '239': '🇸🇹', '240': '🇬🇶', '241': '🇬🇦', '242': '🇨🇬',
      '243': '🇨🇩', '244': '🇦🇴', '245': '🇬🇼', '248': '🇸🇨', '249': '🇸🇩',
      '250': '🇷🇼', '251': '🇪🇹', '252': '🇸🇴', '253': '🇩🇯', '254': '🇰🇪',
      '255': '🇹🇿', '256': '🇺🇬', '257': '🇧🇮', '258': '🇲🇿', '260': '🇿🇲',
      '261': '🇲🇬', '262': '🇷🇪', '263': '🇿🇼', '264': '🇳🇦', '265': '🇲🇼',
      '266': '🇱🇸', '267': '🇧🇼', '268': '🇸🇿', '269': '🇰🇲', '350': '🇬🇮',
      '351': '🇵🇹', '352': '🇱🇺', '353': '🇮🇪', '354': '🇮🇸', '355': '🇦🇱',
      '356': '🇲🇹', '357': '🇨🇾', '358': '🇫🇮', '359': '🇧🇬', '370': '🇱🇹',
      '371': '🇱🇻', '372': '🇪🇪', '373': '🇲🇩', '374': '🇦🇲', '375': '🇧🇾',
      '376': '🇦🇩', '377': '🇲🇨', '378': '🇸🇲', '380': '🇺🇦', '381': '🇷🇸',
      '382': '🇲🇪', '383': '🇽🇰', '385': '🇭🇷', '386': '🇸🇮', '387': '🇧🇦',
      '389': '🇲🇰', '420': '🇨🇿', '421': '🇸🇰', '423': '🇱🇮', '592': '🇬🇾',
      '595': '🇵🇾', '598': '🇺🇾', '675': '🇵🇬', '678': '🇻🇺', '686': '🇰🇮',
      '850': '🇰🇵', '852': '🇭🇰', '853': '🇲🇴', '855': '🇰🇭', '856': '🇱🇦',
      '880': '🇧🇩', '886': '🇹🇼', '960': '🇲🇻', '961': '🇱🇧', '962': '🇯🇴',
      '963': '🇸🇾', '964': '🇮🇶', '965': '🇰🇼', '966': '🇸🇦', '967': '🇾🇪',
      '968': '🇴🇲', '970': '🇵🇸', '971': '🇦🇪', '972': '🇮🇱', '973': '🇧🇭',
      '974': '🇶🇦', '975': '🇧🇹', '976': '🇲🇳', '977': '🇳🇵', '992': '🇹🇯',
      '993': '🇹🇲', '994': '🇦🇿', '995': '🇬🇪', '996': '🇰🇬', '998': '🇺🇿'
    };
    for (let len = 3; len >= 1; len--) {
      const code = number.slice(0, len);
      if (countryFlags[code]) return countryFlags[code];
    }
    return '🏳️'; // bandera blanca si no se encuentra
  }

  const pesan = args.join` `;
  const oi = `*» INFO :* ${pesan}`;
  let teks = `*!  MENCION GENERAL  !*\n  *PARA ${participants.length} MIEMBROS* 🗣️\n\n ${oi}\n\n╭  ┄ 𝅄 ۪꒰ \`⡞᪲=͟͟͞${botname} ≼᳞ׄ\` ꒱ ۟ 𝅄 ┄\n`;
  for (const mem of participants) {
    const num = mem.id.split('@')[0];
    const flag = getFlagFromNumber(num);
    teks += `┊${flag} @${num}\n`;
  }
  teks += `╰⸼ ┄ ┄ ┄ ─  ꒰  ׅ୭ *${vs}* ୧ ׅ ꒱  ┄  ─ ┄ ⸼`;

  conn.sendMessage(m.chat, { text: teks, mentions: participants.map(a => a.id) });
};

handler.help = ['todos *<mensaje>*'];
handler.tags = ['group'];
handler.command = ['todos', 'invocar', 'tagall'];
handler.admin = true;
handler.group = true;

export default handler;